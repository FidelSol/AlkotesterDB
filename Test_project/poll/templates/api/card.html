<!doctype html>
<html lang="en">

<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link href="https://unpkg.com/bootstrap-table@1.18.1/dist/bootstrap-table.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.1.2/css/tempusdominus-bootstrap-4.min.css" integrity="sha256-XPTBwC3SBoWHSmKasAk01c08M6sIA5gF5+sRxqak2Qs=" crossorigin="anonymous">
<link rel="icon" href="https://getbootstrap.com/docs/4.5/assets/img/favicons/favicon.ico">
</head>

<body>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
<script src="https://unpkg.com/tableexport.jquery.plugin/tableExport.min.js"></script>
<script src="https://unpkg.com/bootstrap-table@1.18.1/dist/bootstrap-table.min.js"></script>
<script src="https://unpkg.com/bootstrap-table@1.18.1/dist/bootstrap-table-locale-all.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.18.1/locale/bootstrap-table-ru-RU.min.js"></script>
<script src="https://unpkg.com/bootstrap-table@1.18.1/dist/extensions/export/bootstrap-table-export.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.1.2/js/tempusdominus-bootstrap-4.min.js" integrity="sha256-z0oKYg6xiLq3yJGsp/LsY9XykbweQlHl42jHv2XTBz4=" crossorigin="anonymous"></script>

<style>
.card1 {
    box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2);
    width: 450px;
    margin: auto;
    text-align: center;
}
.dark {
    border: none;
    padding: 8px;
    color: white;
    background-color:  #2f4f4f;
    text-align: center;
}
.card2 {

    box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2);
    width: 1000px;
    margin: auto;
    text-align: center;
}
table {
    margin: auto;
}

.title {
    color: black;
    font-size: 18px;
}

button {
    border: none;
    outline: 0;
    display: inline-block;
    padding: 8px;
    color: white;
    background-color: #2f4f4f;
    text-align: center;
    cursor: pointer;
    width: 100%;
    font-size: 20px;
}

p {
  font-size: 15px;
  color: black;
}

a {
    text-decoration: none;
    font-size: 22px;
    color: black;
}

button:hover, a:hover {
    opacity: 0.7;
}

.select,
  #locale {
    width: 100%;
  }

.form-group {
     width: 100%;
     height: 100%;
}

</style>


<br>
<div class="row">



<div class="card1">
  <div class="dark">
  <b>СОТРУДНИК</b>
  </div>
  {% load static %}
  <p>{% for photo in photos %}
  <img src="/{{ photo.data_photo }}" width="200" height="222">
  {% endfor %}</p>
  <h1>{{ persona.full_name }}</h1>
  <p><b>Персональный ID: {{ persona.personal_id }}</b></p>
  <p><b>Расширенный ID: {{ persona.ext_id }}</b></p>
  <p><b>Дата рождения: {{ persona.birth_date }}</b></p>
  <p><b>Должность: {{ persona.position }}</b></p>
  <p><b>Взыскания: {{ persona.punishment }}</b></p>


  <div class="btn-group btn-group dropup">
    <div class="dropdown mr-4">
  <button type="button" class="btn btn-secondary dropdown-toggle" style="border: none;
    outline: 0;
    display: inline-block;
    padding: 8px;
    color: white;
    background-color: #2f4f4f;
    text-align: center;
    cursor: pointer;
    width: 100%;
    font-size: 20px; width: 450px;" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Редактировать</button>

  <div class="dropdown-menu" style="width: 450px;">
    <form class="px-4 py-3" method="post" id="ajax_put" style="text-align: center;" enctype="multipart/form-data" action="">

      <input type="hidden" name="_method" value="PUT">
      {% csrf_token %}
        <div class="input-group mb-3">
          <div class="input-group-prepend">
          <span class="input-group-text" id="basic-addon1">Расширенный ID</span>
          </div>
          <input type="number" class="form-control" name="ext_id_put" value="{{ persona.ext_id }}" placeholder="Расширенный ID" /><br>

          </div>

        <div class="input-group mb-3">
          <div class="input-group-prepend">
          <span class="input-group-text" id="basic-addon2">ФИО</span>
          </div>
        <input type="text" class="form-control" name="full_name_put" value="{{ persona.full_name }}" placeholder="ФИО"/>
        </div>

        <div class="input-group mb-3">
                    <div class="input-group-prepend">
                    <span class="input-group-text" id="basic-addon3">Д.Р.</span>

                    <div class="input-group date" id="datetimepicker_p" style="width: 350px;" data-target-input="nearest">
                    <input type="text" class="form-control datetimepicker-input" name="birth_date_put" data-target="#datetimepicker_p" value="{{ persona.birth_date }}" placeholder="Дата рождения"/>
                    <div class="input-group-append" data-target="#datetimepicker_p" data-toggle="datetimepicker"><div class="input-group-text"><i class="fa fa-calendar"></i></div>
                    </div></div>
                      </div>
        </div>


        <div class="input-group mb-3">
          <div class="input-group-prepend">
          <span class="input-group-text" id="basic-addon4">Должность</span>
          </div>
        <input type="text" class="form-control" name="position_put" value="{{ persona.position }}" placeholder="Должность"/>
        </div>

        <div class="input-group mb-3">
          <div class="input-group-prepend">
          <span class="input-group-text" id="basic-addon5">Взыскания</span>
          </div>
        <input type="text" class="form-control" name="punishment_put" value="{{ persona.punishment }}" placeholder="Взыскания"/>
        </div>

        <input type="submit" class="btn btn-primary" id="btn_put" value="Сохранить" />

  </form>
 </div>
</div>
</div>
</div>



<div class="card2">
  <div class="dark">
  <b>СПИСОК ТЕСТОВ СОТРУДНИКА</b>
  </div>

  <div id="toolbar">
    <div class="btn-toolbar" role="toolbar" aria-label="Toolbar with button groups">

      <div class="btn-group mr-2" role="group" aria-label="First group">
        <button id="remove" class="btn btn-danger" disabled>
        <i class="fa fa-trash"></i> Удалить
        </button>
      </div>


    <div class="btn-group mr-2" role="group" aria-label="Second group">
      <div class="dropdown mr-4">
        <button type="button" class="btn btn-secondary dropdown-toggle" style="width: 200px;" id="dropdownMenuOffset" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" data-offset="10,20">
        Добавить
        </button>
        <div class="dropdown-menu">

  <form class="px-4 py-3" method="post" id="ajax_form" enctype="multipart/form-data" style="width: 300px;" action="/api/v1/tests/">
        {% csrf_token %}

        <div class="form-group">
                    <div class="input-group date" id="datetimepicker1" data-target-input="nearest">
                    <input type="text" class="form-control datetimepicker-input" name="expected_time" data-target="#datetimepicker1" placeholder="Назнач. время"/>
                    <div class="input-group-append" data-target="#datetimepicker1" data-toggle="datetimepicker"><div class="input-group-text"><i class="fa fa-calendar"></i></div>
                    </div>
                    </div>
        </div>

        <div class="form-group">
                    <div class="input-group date" id="datetimepicker2" data-target-input="nearest">
                    <input type="text" class="form-control datetimepicker-input" name="result_time" data-target="#datetimepicker2" placeholder="Фактич. время"/>
                    <div class="input-group-append" data-target="#datetimepicker2" data-toggle="datetimepicker"><div class="input-group-text"><i class="fa fa-calendar"></i></div>
                    </div>
                    </div>
        </div>

        <div class="form-group">
                    <div class="form-check">
                    <label class="form-check-label">
                    <input class="form-check-input" type="checkbox" name="result" placeholder="Результат"/>Результат
                    </label>
                    </div>
        </div>


        <input type="submit" class="btn btn-primary" id="btn" value="Сохранить" />

  </form>
</div>
</div>
</div></div>
</div>

  <table
          id="table"
          data-toggle="table"
          data-toolbar="#toolbar"
          data-search="true"
          data-show-refresh="true"
          data-show-toggle="true"
          data-show-fullscreen="true"
          data-show-columns="true"
          data-show-columns-toggle-all="true"
          data-detail-view="true"
          data-show-export="true"
          data-checkbox-header="true"
          data-click-to-select="true"
          data-detail-formatter="detailFormatter"
          data-minimum-count-columns="2"
          data-show-pagination-switch="true"
          data-pagination="true"
          data-page-list="[10, 25, 50, 100, all]"
          data-show-footer="true"
          data-side-pagination="server"
          data-buttons="buttons"
          data-response-handler="responseHandler">

    <thead class="thead-dark">
    <tr>
      <th scope="col" data-field="state" data-checkbox="true"></th>
      <th scope="col" data-field="tests_id">Тест ID</th>
      <th scope="col" data-field="expected_time">Назначенное время сдачи теста</th>
      <th scope="col" data-field="result_time">Фактическое время сдачи теста</th>
      <th scope="col" data-field="result">Результат</th>
      <th scope="col" data-field="operate" data-formatter="operateFormatter"
          data-events="operateEvents">Удалить</th>
    </tr>
  </thead>

    <tbody>
    {% for test in tests %}
    <tr>
      <th scope="row"></th>
      <th scope="row">{{ test.tests_id }}</th>
      <th scope="row">{{ test.expected_time }}</th>
      <th scope="row">{{ test.result_time }}</th>
      <th scope="row">{{ test.result }}</th>
      <th scope="row"></th>
      </tr>
     {% endfor %}
    </tbody>
</table>


</div>

</div>



<script type="text/javascript">
    var $table = $('#table')
    var $remove = $('#remove')
    var selections = []
    var $button = $('#button')
    var csrftoken = $.cookie('csrftoken');


    function getIdSelections() {
    return $.map($table.bootstrapTable('getSelections'), function (row) {
      return row.tests_id
        })
    }

    function responseHandler(res) {
    $.each(res.rows, function (i, row) {
      row.state = $.inArray(row.tests_id, selections) !== -1
    })
    return res
    }


    function detailFormatter(index, row) {
    var html = []
    $.each(row, function (key, value) {
      html.push('<p><b>' + key + ':</b> ' + value + '</p>')
    })
    var html_result = [html[3], html[5], html[7], html[9]]
    return html_result.join('')
    }


    function operateFormatter(value, row, index) {
    return [
      '<a class="remove" href="javascript:void(0)" title="Remove">',
      '<i class="fa fa-trash"></i>',
      '</a>'
    ].join('')
    }


    window.operateEvents = {
    'click .remove': function (e, value, row, index) {
        $.ajax({
          url: "/api/v1/tests/" + row.tests_id +"/",
          method: "delete",
          dataType: "json",
          success: function(){
                 $table.bootstrapTable('remove', {
                 field: 'tests_id',
                 values: [row.tests_id], }),
                 alert("Тест удален");}

          })
    }}

// Функция таблицы
 $(function Table() {
    var data =
        [{
          field: 'state',
          checkbox: true,
          rowspan: 1,
          align: 'center',
          valign: 'middle'
        },{
            field: 'tests_id',
            title: 'Тест ID',
            rowspan: 1,
            align: 'center',
            valign: 'middle',
            sortable: true,
        },
        {
            field: 'expected_time',
            title: 'Назначенное время сдачи теста',
            sortable: true,
            align: 'center',
        },{
            field: 'result_time',
            title: 'Фактическое время сдачи теста',
            sortable: true,
            align: 'center',
        },{
            field: 'result',
            title: 'Результат',
            sortable: true,
            align: 'center',
        },{
            field: 'operate',
            title: 'Удалить',
            align: 'center',
            clickToSelect: false,
            events: window.operateEvents,
            formatter: operateFormatter
        }
       ]
       $table.bootstrapTable({data: data})
      })


// выбор ряда checkbox
 $table.on('check.bs.table uncheck.bs.table ' +
      'check-all.bs.table uncheck-all.bs.table',
    function () {
      $remove.prop('disabled', !$table.bootstrapTable('getSelections').length)
        selections = getIdSelections()
      })

 $table.on('all.bs.table', function (e, name, args) {
      console.log(name, args)
    })

// Удаление тестов согласно выбранным рядам checkbox
 $remove.click(function () {
               var ids = getIdSelections()

    ids.forEach(function(value, index, ids) {
        $.ajax({
          url: "/api/v1/tests/" + ids[index] +"/",
          method: "delete",
          dataType: "json",
          success: function(){
            $table.bootstrapTable('remove', {
              field: 'tests_id',
              values: ids,
            })
          }
        })
 })
  $remove.prop('disabled', true)
})


// перевод значения checkbox в Boolean
function Boolean(string){
    switch(string.toLowerCase().trim()){
        case "true": case "yes": case "1": case "on":  return true;
        case "false": case "no": case "0": case null: return false;
        default: return Boolean(string);
    }
}

// Создание токена для метода POST через формы
function csrfSafeMethod(method) {
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
}

$.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
    }
});

// Календарь dominus
$(function () {
        $("#datetimepicker1").datetimepicker({ locale: 'ru', format: 'YYYY-MM-DDTHH:mm:ss', });
        $("#datetimepicker2").datetimepicker({ locale: 'ru', format: 'YYYY-MM-DDTHH:mm:ss', });
        $("#datetimepicker_p").datetimepicker({ locale: 'ru', format: 'YYYY-MM-DD', });
      });


console.log({{ persona.personal_id }})
var x = {{ persona.personal_id }}


// Добавление тестов данного сотрудника
$(function() {

  function Boolean(string){
    switch(string.toLowerCase().trim()){
        case "true": case "yes": case "1": case "on":  return true;
        case "false": case "no": case "0": case null: return false;
        default: return Boolean(string);
    }
}



  $("#btn").click(function(){
			var elements = document.getElementById("ajax_form").elements;
            var data = {};
            for(var i = 0 ; i < 6 ; i++){
            var item = elements.item(i);
            data[item.name] = item.value;
		    }


            var csrfmiddlewaretoken = data.csrfmiddlewaretoken
		    var x = {{ persona.personal_id }}
            var expected_time = data.expected_time
            var result_time = data.result_time
            var result = Boolean(data.result)



    $.ajax({
        url: "/api/v1/tests/",
        type: "POST",
        dataType: "application/json; charset=utf-8",
        dataType: "json",

        data:          {
                        'personal_id': x,
                        'expected_time': expected_time,
                        'result_time': result_time,
                        'result': result},
        success: function(response) {

        	console.log(JSON.stringify(data));
    	},
    	error: function(response) {
    	    console.log({
                        'personal_id': personal_id,
                        'expected_time': expected_time,
                        'result_time': result_time,
                        'result': result})

    	}
 	});
 })
})


// Не отправляет снова формы при обновлении страницы
 if ( window.history.replaceState ) {
 window.history.replaceState( null, null, window.location.href );}



// Редактирование профиля

$("#btn_put").click(function(){

			var elements = document.getElementById("ajax_put").elements;
            var data = {};
            for(var i = 2 ; i < 7 ; i++){
            var item = elements.item(i);
            data[item.name] = item.value;
		    }

            var ext_id = parseInt(data.ext_id_put)
            var full_name = data.full_name_put
            var birth_date = data.birth_date_put
            var position = data.position_put
            var punishment = parseInt(data.punishment_put)

            $.ajax({
                url: "/api/v1/personals/" + x +"/",
                type: "PUT",
                dataType: "application/json; charset=utf-8",
                dataType: "json",
                data: {
                        'ext_id': ext_id,
                        'full_name': full_name,
                        'birth_date': birth_date,
                        'position': position,
                        'punishment': punishment },
                success: function(response) {
        	        console.log(JSON.stringify(data));
                },
                error: function(response) {
                    console.log(JSON.stringify(data))
                }
            })
             console.log(data)

})




</script>

</body>
</html>



